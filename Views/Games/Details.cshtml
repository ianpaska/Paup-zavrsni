@model Tuple<GameShop3.Models.Game, List<GameShop3.Models.Comment>>
@using GameShop3.Models
@{
    var game = Model.Item1;
    var comments = Model.Item2;
    ViewBag.Title = game.Title;

    string imageFileName = game.Title + ".jpg";
    string imagePath = Url.Content("~/Content/Images/Games/" + imageFileName);

    //  opis 
    string[] sentences = game.Description.Split(new[] { '.' }, StringSplitOptions.RemoveEmptyEntries);
    string shortDescription = string.Join(". ", sentences.Take(3)) + ".";
}

@*  background *@
<div class="Background" style="
     position:fixed;
     top:0;
     left:0;
     width:100%;
     height:100%;
     background-image:url('@Url.Content("~/Content/Images/background.jpg")');
     background-size:cover;
     background-position:center;
     background-repeat:no-repeat;
     z-index:-1;">
</div>

<div class="container" style="
     background-color:rgba(255,255,255,0.9);
     padding:20px;
     border-radius:5px;
     margin:30px auto;
     max-width:1200px;">

    <h2>@game.Title</h2>

    @* Slika lijevo, tekst desno *@
    <div style="display:flex; align-items:flex-start; margin-bottom:20px; gap:20px;">
        <div style="text-align:center;">
            <img src="@imagePath" alt="@game.Title"
                 style="width:300px; height:400px; object-fit:cover; border-radius:5px;" />
            <p style="margin-top:10px; color:#555;">
                <b>Opis:</b> @shortDescription
            </p>
        </div>
        <div style="flex:1;">
            <p><b>Kategorija:</b> @game.Category</p>
            <p><b>Platforme:</b> @string.Join(", ", game.Platforms)</p>
            <p><b>Cijena:</b> @game.Price.ToString("0.00") €</p>
            <p><b>Prosj. ocjena:</b> @ViewBag.Avg.ToString("0.0")</p>
        </div>
    </div>

    @if (TempData["Msg"] != null)
    {
        <div class="alert alert-info">@TempData["Msg"]</div>
    }

    <p>
        @if (User.Identity.IsAuthenticated)
        {
            @Html.ActionLink("Kupi igru", "Buy", "Orders", new { gameId = game.Id }, new { @class = "btn btn-primary" })
        }
        else
        {
            <a href="@Url.Action("Login","Account", new { ReturnUrl = Url.Action("Details","Games", new { id = game.Id }) })" class="btn btn-primary">Prijavi se za kupnju</a>
        }
    </p>

    <hr />
    <h3>Komentari</h3>

    @if (comments.Count == 0)
    {
        <p>Nema komentara.</p>
    }
    else
    {
        <ul>
            @foreach (var c in comments)
            {
                <li>
                    <b>@c.UserEmail</b> (@c.Rating/5) — @c.CreatedAt.ToLocalTime():
                    <br />@c.Text
                </li>
            }
        </ul>
    }

    @if (ViewBag.CanComment == true)
    {
        <hr />
        <h4>Dodaj komentar</h4>

        using (Html.BeginForm("AddComment", "Games", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.Hidden("gameId", game.Id)
            <label>Ocjena (1-5):</label>
            <input type="number" name="rating" value="5" min="1" max="5" />
            <br />
            <label>Komentar:</label>
            <br />
            <textarea name="text" rows="3" cols="50"></textarea>
            <br />
            <button type="submit" class="btn btn-success">Spremi</button>
        }
    }
    else
    {
        <p><i>Za komentiranje i ocjenu potrebno je kupiti igru.</i></p>
    }
</div>
